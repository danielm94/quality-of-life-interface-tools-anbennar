#SCOPE = COUNTRY
upgrade_all_trade_buildings_to_trade_depots = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_trade_depot = yes
			any_owned_province = {
				has_building = marketplace
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_trade_value_province_to_trade_depot = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = marketplace
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = trade_depot
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_trade_value_province_to_trade_depot = {
	every_owned_province = {
		limit = {
			NOT = {
				has_construction = any
			}
			has_building = marketplace
		}
		export_to_variable = {
			which = local_trade_power
			value = province_trade_power
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_trade_power_province
				}
			}
			save_global_event_target_as = highest_trade_power_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = local_trade_power
						which = event_target:highest_trade_power_province
					}
				}
				save_global_event_target_as = highest_trade_power_province
			}
		}
	}
	event_target:highest_trade_power_province = {
		add_building_construction = {
			building = trade_depot
		}
	}
	clear_global_event_target = highest_trade_power_province
}

#SCOPE = COUNTRY
upgrade_all_trade_buildings_to_stock_exchanges = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_stock_exchange = yes
			any_owned_province = {
				OR = {
					has_building = marketplace
					has_building = trade_depot
				}
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_trade_value_province_to_stock_exchange = yes
		}
		else = {
			random_owned_province = {
				limit = {
					OR = {
						has_building = marketplace
						has_building = trade_depot
					}
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = stock_exchange
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_trade_value_province_to_stock_exchange = {
	every_owned_province = {
		limit = {
			OR = {
				has_building = marketplace
				has_building = trade_depot
			}
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = local_trade_power
			value = province_trade_power
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_trade_power_province
				}
			}
			save_global_event_target_as = highest_trade_power_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = local_trade_power
						which = event_target:highest_trade_power_province
					}
				}
				save_global_event_target_as = highest_trade_power_province
			}
		}
	}
	event_target:highest_trade_power_province = {
		add_building_construction = {
			building = stock_exchange
		}
	}
	clear_global_event_target = highest_trade_power_province
}

#SCOPE = COUNTRY
upgrade_all_government_buildings_to_town_halls = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_town_hall = yes
			any_owned_province = {
				has_building = courthouse
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_gov_cost_province_to_town_hall = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = courthouse
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = town_hall
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_gov_cost_province_to_town_hall = {
	every_owned_province = {
		limit = {
			has_building = courthouse
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = dev
			value = development
		}
		set_variable = {
			which = local_governing_cost
			which = dev
		}
		set_variable = {
			which = local_governing_cost_modifier
			value = 1
		}
		export_to_variable = {
			which = local_governing_cost_modifier_raw
			value = modifier:local_governing_cost
		}
		change_variable = {
			which = local_governing_cost_modifier
			which = local_governing_cost_modifier_raw
		}
		multiply_variable = {
			which = local_governing_cost
			which = local_governing_cost_modifier
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_gov_cost_province
				}
			}
			save_global_event_target_as = highest_gov_cost_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = local_governing_cost
						which = event_target:highest_gov_cost_province
					}
				}
				save_global_event_target_as = highest_gov_cost_province
			}
		}
	}
	event_target:highest_gov_cost_province = {
		add_building_construction = {
			building = town_hall
		}
	}
	clear_global_event_target = highest_gov_cost_province
}

#SCOPE = COUNTRY
upgrade_all_dock_buildings_to_dry_docks = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_drydock = yes
			any_owned_province = {
				has_building = dock
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_sailor_province_to_dry_dock = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = dock
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = drydock
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_sailor_province_to_dry_dock = {
	every_owned_province = {
		limit = {
			has_building = dock
			NOT = {
				has_construction = any
			}
		}
		#Province gains a base +60 dev per point of development, so naturally the province with the most development has the most base sailors.
		export_to_variable = {
			which = sailors_total
			value = development
		}
		export_to_variable = {
			which = sailors_mod
			value = modifier:local_sailors_modifier
		}
		multiply_variable = {
			which = sailors_total
			which = sailors_mod
		}
		export_to_variable = {
			which = curr_autonomy
			value = local_autonomy
		}
		set_variable = {
			which = autonomy_to_multiply
			value = 100
		}
		subtract_variable = {
			which = autonomy_to_multiply
			which = curr_autonomy
		}
		divide_variable = {
			which = autonomy_to_multiply
			value = 100
		}
		multiply_variable = {
			which = sailors_total
			which = autonomy_to_multiply
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_sailor_province
				}
			}
			save_global_event_target_as = highest_sailor_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = sailors_total
						which = event_target:highest_sailor_province
					}
				}
				save_global_event_target_as = highest_sailor_province
			}
		}
	}
	event_target:highest_sailor_province = {
		add_building_construction = {
			building = drydock
		}
	}
	clear_global_event_target = highest_sailor_province
}

#SCOPE = COUNTRY
upgrade_all_shipyard_buildings_to_grand_shipyards = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_grand_shipyard = yes
			any_owned_province = {
				has_building = shipyard
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_lowest_autonomy_province_to_grand_shipyard = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = shipyard
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = grand_shipyard
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_lowest_autonomy_province_to_grand_shipyard = {
	every_owned_province = {
		limit = {
			has_building = shipyard
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = curr_autonomy
			value = local_autonomy
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = lowest_autonomy_province
				}
			}
			save_global_event_target_as = lowest_autonomy_province
		}
		else = {
			if = {
				limit = {
					NOT = {
						check_variable = {
							which = curr_autonomy
							which = event_target:lowest_autonomy_province
						}
					}
				}
				save_global_event_target_as = lowest_autonomy_province
			}
		}
	}
	event_target:lowest_autonomy_province = {
		add_building_construction = {
			building = grand_shipyard
		}
	}
	clear_global_event_target = lowest_autonomy_province
}

#SCOPE = COUNTRY
upgrade_all_workshop_buildings_to_counting_houses = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_counting_house = yes
			any_owned_province = {
				has_building = workshop
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_production_province_to_counting_house = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = workshop
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = counting_house
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_production_province_to_counting_house = {
	every_owned_province = {
		limit = {
			has_building = workshop
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = local_trade_goods_size
			value = modifier:trade_goods_size
		}
		set_variable = {
			which = local_production_score
			which = local_trade_goods_size
		}
		export_to_variable = {
			which = base_prod
			value = trigger_value:base_production
		}
		multiply_variable = {
			which = local_production_score
			which = base_prod
		}
		export_to_variable = {
			which = curr_autonomy
			value = local_autonomy
		}
		if = {
			limit = {
				NOT = {
					check_variable = {
						which = curr_autonomy
						which = 0.001
					}
				}
			}
			#Prevent dividing by 0
			set_variable = {
				which = curr_autonomy
				value = 0.001
			}
		}
		divide_variable = {
			which = local_production_score
			which = curr_autonomy
		}
		export_to_variable = {
			which = local_trade_goods_size_modifier
			value = modifier:trade_goods_size_modifier
		}
		change_variable = {
			which = local_trade_goods_size_modifier
			value = 1
		}
		multiply_variable = {
			which = local_production_score
			which = local_trade_goods_size_modifier
		}
		export_to_variable = {
			which = local_production_mod
			value = modifier:local_production_efficiency
		}
		change_variable = {
			which = local_production_mod
			value = 1
		}
		multiply_variable = {
			which = local_production_score
			which = local_production_mod
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_production_province
				}
			}
			save_global_event_target_as = highest_production_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = local_production_score
						which = event_target:highest_production_province
					}
				}
				save_global_event_target_as = highest_production_province
			}
		}
	}
	event_target:highest_production_province = {
		add_building_construction = {
			building = counting_house
		}
	}
	clear_global_event_target = highest_production_province
}

#SCOPE = COUNTRY
upgrade_all_manpower_buildings_to_training_fields = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_training_fields = yes
			any_owned_province = {
				has_building = barracks
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_manpower_province_to_training_fields = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = barracks
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = training_fields
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_manpower_province_to_training_fields = {
	every_owned_province = {
		limit = {
			has_building = barracks
			NOT = {
				has_construction = any
			}
		}
		set_variable = {
			which = manpower_total
			value = 0
		}
		export_to_variable = {
			which = manpower_base
			value = trigger_value:base_manpower
			who = this
		}
		set_variable = {
			which = manpower_total
			value = 250
		}
		multiply_variable = {
			which = manpower_total
			which = manpower_base
		}
		export_to_variable = {
			which = manpower_mod
			value = modifier:local_manpower_modifier
		}
		multiply_variable = {
			which = manpower_total
			which = manpower_mod
		}
		export_to_variable = {
			which = curr_autonomy
			value = local_autonomy
		}
		set_variable = {
			which = autonomy_to_multiply
			value = 100
		}
		subtract_variable = {
			which = autonomy_to_multiply
			which = curr_autonomy
		}
		divide_variable = {
			which = autonomy_to_multiply
			value = 100
		}
		multiply_variable = {
			which = manpower_total
			which = autonomy_to_multiply
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_manpower_province
				}
			}
			save_global_event_target_as = highest_manpower_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = manpower_total
						which = event_target:highest_manpower_province
					}
				}
				save_global_event_target_as = highest_manpower_province
			}
		}
	}
	event_target:highest_manpower_province = {
		add_building_construction = {
			building = training_fields
		}
	}
	clear_global_event_target = highest_manpower_province
}

#SCOPE = COUNTRY
upgrade_all_force_limit_buildings_to_conscription_center = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_conscription_center = yes
			any_owned_province = {
				has_building = regimental_camp
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_lowest_autonomy_province_to_conscription_center = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = regimental_camp
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = conscription_center
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_lowest_autonomy_province_to_conscription_center = {
	every_owned_province = {
		limit = {
			has_building = regimental_camp
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = curr_autonomy
			value = local_autonomy
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = lowest_autonomy_province
				}
			}
			save_global_event_target_as = lowest_autonomy_province
		}
		else = {
			if = {
				limit = {
					NOT = {
						check_variable = {
							which = curr_autonomy
							which = event_target:lowest_autonomy_province
						}
					}
				}
				save_global_event_target_as = lowest_autonomy_province
			}
		}
	}
	event_target:lowest_autonomy_province = {
		add_building_construction = {
			building = conscription_center
		}
	}
	clear_global_event_target = lowest_autonomy_province
}

#SCOPE = COUNTRY
upgrade_all_tax_buildings_to_cathedrals = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_cathedral = yes
			any_owned_province = {
				has_building = temple
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			upgrade_highest_tax_province_to_cathedral = yes
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = temple
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = cathedral
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_highest_tax_province_to_cathedral = {
	every_owned_province = {
		limit = {
			has_building = temple
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = local_yearly_tax_income
			value = modifier:tax_income
		}
		export_to_variable = {
			which = local_base_tax
			value = trigger_value:base_tax
		}
		set_variable = {
			which = local_monthly_tax_income
			which = local_yearly_tax_income
		}
		change_variable = {
			which = local_monthly_tax_income
			which = local_base_tax
		}
		divide_variable = {
			which = local_monthly_tax_income
			value = 12
		}
		export_to_variable = {
			which = local_tax_mod
			value = modifier:local_tax_modifier
		}
		export_to_variable = {
			which = global_tax_mod
			value = modifier:global_tax_modifier
			who = ROOT
		}
		set_variable = {
			which = tax_modifier
			which = global_tax_mod
		}
		change_variable = {
			which = tax_modifier
			which = local_tax_mod
		}
		multiply_variable = {
			which = local_monthly_tax_income
			which = tax_modifier
		}
		export_to_variable = {
			which = local_autonomy_raw
			value = local_autonomy
		}
		set_variable = {
			which = local_autonomy
			value = 100
		}
		subtract_variable = {
			which = local_autonomy
			which = local_autonomy_raw
		}
		divide_variable = {
			which = local_autonomy
			value = 100
		}
		multiply_variable = {
			which = local_monthly_tax_income
			which = local_autonomy
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = highest_tax_province
				}
			}
			save_global_event_target_as = highest_tax_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = local_monthly_tax_income
						which = event_target:highest_tax_province
					}
				}
				save_global_event_target_as = highest_tax_province
			}
		}
	}
	event_target:highest_tax_province = {
		add_building_construction = {
			building = cathedral
		}
	}
	clear_global_event_target = highest_tax_province
}

#SCOPE = COUNTRY
upgrade_all_fort_buildings_to_level_4_fort = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_fort_16th = yes
			any_owned_province = {
				has_building = fort_15th
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			if = {
				limit = {
					capital_scope = {
						has_building = fort_15th
						NOT = {
							has_construction = any
						}
					}
				}
				capital_scope = {
					add_building_construction = {
						building = fort_16th
					}
				}
			}
			else = {
				upgrade_most_defensive_province_to_level_4_fort = yes
			}
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = fort_15th
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = fort_16th
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_most_defensive_province_to_level_4_fort = {
	every_owned_province = {
		limit = {
			has_building = fort_15th
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = def
			value = modifier:local_defensiveness
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = most_defensive_province
				}
			}
			save_global_event_target_as = most_defensive_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = def
						which = event_target:most_defensive_province
					}
				}
				save_global_event_target_as = most_defensive_province
			}
		}
	}
	event_target:most_defensive_province = {
		add_building_construction = {
			building = fort_16th
		}
	}
	clear_global_event_target = most_defensive_province
}

#SCOPE = COUNTRY
upgrade_all_fort_buildings_to_level_6_fort = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_fort_17th = yes
			any_owned_province = {
				OR = {
					has_building = fort_15th
					has_building = fort_16th
				}
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			#Always prioritize capital
			if = {
				limit = {
					capital_scope = {
						OR = {
							has_building = fort_15th
							has_building = fort_16th
						}
						NOT = {
							has_construction = any
						}
					}
				}
				capital_scope = {
					add_building_construction = {
						building = fort_17th
					}
				}
			}
			else = {
				upgrade_most_defensive_province_to_level_6_fort = yes
			}
		}
		else = {
			random_owned_province = {
				limit = {
					OR = {
						has_building = fort_15th
						has_building = fort_16th
					}
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = fort_17th
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_most_defensive_province_to_level_6_fort = {
	every_owned_province = {
		limit = {
			OR = {
				has_building = fort_15th
				has_building = fort_16th
			}
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = def
			value = modifier:local_defensiveness
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = most_defensive_province
				}
			}
			save_global_event_target_as = most_defensive_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = def
						which = event_target:most_defensive_province
					}
				}
				save_global_event_target_as = most_defensive_province
			}
		}
	}
	event_target:most_defensive_province = {
		add_building_construction = {
			building = fort_17th
		}
	}
	clear_global_event_target = most_defensive_province
}

#SCOPE = COUNTRY
upgrade_all_fort_buildings_to_level_8_fort = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_fort_18th = yes
			any_owned_province = {
				OR = {
					has_building = fort_15th
					has_building = fort_16th
					has_building = fort_17th
				}
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			#Always prioritize capital
			if = {
				limit = {
					capital_scope = {
						OR = {
							has_building = fort_15th
							has_building = fort_16th
							has_building = fort_17th
						}
						NOT = {
							has_construction = any
						}
					}
				}
				capital_scope = {
					add_building_construction = {
						building = fort_18th
					}
				}
			}
			else = {
				upgrade_most_defensive_province_to_level_8_fort = yes
			}
		}
		else = {
			random_owned_province = {
				limit = {
					OR = {
						has_building = fort_15th
						has_building = fort_16th
						has_building = fort_17th
					}
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = fort_18th
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
upgrade_most_defensive_province_to_level_8_fort = {
	every_owned_province = {
		limit = {
			OR = {
				has_building = fort_15th
				has_building = fort_16th
				has_building = fort_17th
			}
			NOT = {
				has_construction = any
			}
		}
		export_to_variable = {
			which = def
			value = modifier:local_defensiveness
		}
		if = {
			limit = {
				NOT = {
					has_saved_global_event_target = most_defensive_province
				}
			}
			save_global_event_target_as = most_defensive_province
		}
		else = {
			if = {
				limit = {
					check_variable = {
						which = def
						which = event_target:most_defensive_province
					}
				}
				save_global_event_target_as = most_defensive_province
			}
		}
	}
	event_target:most_defensive_province = {
		add_building_construction = {
			building = fort_18th
		}
	}
	clear_global_event_target = most_defensive_province
}

#SCOPE = COUNTRY
upgrade_all_coastal_defenses_to_naval_battery = {
	hidden_effect = {
		set_variable = {
			which = iteration_counter
			which = upgrade_building_quantity
		}
	}
	calculate_building_upgrade_costs = yes
	while = {
		limit = {
			if = {
				limit = {
					check_variable = {
						which = upgrade_building_quantity
						value = 0
					}
				}
				check_variable = {
					which = iteration_counter
					value = 1
				}
			}
			can_afford_to_upgrade_naval_battery = yes
			any_owned_province = {
				has_building = coastal_defence
				NOT = {
					has_construction = any
				}
			}
		}
		if = {
			limit = {
				has_country_flag = enable_smart_upgrade_building_macro
			}
			#Always prioritize capital
			if = {
				limit = {
					capital_scope = {
						has_building = coastal_defence
						NOT = {
							has_construction = any
						}
					}
				}
				capital_scope = {
					add_building_construction = {
						building = naval_battery
					}
				}
			}
			else = {
				random_owned_province = {
					limit = {
						has_building = coastal_defence
						NOT = {
							has_construction = any
						}
					}
					add_building_construction = {
						building = naval_battery
					}
				}
			}
		}
		else = {
			random_owned_province = {
				limit = {
					has_building = coastal_defence
					NOT = {
						has_construction = any
					}
				}
				add_building_construction = {
					building = naval_battery
				}
			}
		}
		if = {
			limit = {
				check_variable = {
					which = upgrade_building_quantity
					value = 0
				}
			}
			subtract_variable = {
				which = iteration_counter
				value = 1
			}
		}
	}
}

#SCOPE = COUNTRY
#-1 = build until you have no money left
set_upgrade_building_quantity = {
	hidden_effect = {
		set_variable = {
			which = upgrade_building_quantity
			value = $n$
		}
	}
}

#SCOPE = COUNTRY
setup_upgrade_building_macro = {
	if = {
		limit = {
			NOT = {
				has_country_flag = initialized_upgrade_building_macro
			}
		}
		set_upgrade_building_quantity = {
			n = -1
		}
		set_country_flag = enable_smart_upgrade_building_macro
		set_country_flag = initialized_upgrade_building_macro
	}
}
